<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

<link rel="canonical" href="https://marsettler.com/mongodb/mongodb-study-week-8aggregation/">
<meta property="og:title" content="MongoDB 스터디 8주차(aggregation)" />
<meta property="og:description" content="어그리게이션(Aggregation) 어그리게이션 작업은 데이터를 처리하여 계산된 결과를 반환합니다. 어그리게이션은 여러 도큐먼트의 값을 그룹화하고, 데이터에 다양한 작업을 수행한 후 단일 결과를 반환할 수 있습니다. MongoDB는 세 가지 어그리게이션을 제공합니다.
 Aggregation Pipeline Single Purpose Aggregation Operations Map-reduce  어그리게이션 파이프라인(Aggregation Pipeline) Aggregation pipeline 은 파이프라인 이용해 데이터의 집계를 처리하는 프레임워크입니다. 여러 스테이지에 걸쳐 도큐먼트들을 집계된 결과로 변경합니다.
아래 예를 살펴봅시다:
db.orders.aggregate([{ $match: { status: &#34;A&#34; } },{ $group: { _id: &#34;$custmor_id&#34;, total: { $sum: &#34;$amount&#34; } } }]) $match 스테이지는 도큐먼트들을 status 필드가 &quot;A&quot; 인 데이터만 다음 스테이지로 보냅니다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marsettler.com/mongodb/mongodb-study-week-8aggregation/" />
<meta property="article:published_time" content="2021-03-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-03-11T07:45:48+09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB 스터디 8주차(aggregation)"/>
<meta name="twitter:description" content="어그리게이션(Aggregation) 어그리게이션 작업은 데이터를 처리하여 계산된 결과를 반환합니다. 어그리게이션은 여러 도큐먼트의 값을 그룹화하고, 데이터에 다양한 작업을 수행한 후 단일 결과를 반환할 수 있습니다. MongoDB는 세 가지 어그리게이션을 제공합니다.
 Aggregation Pipeline Single Purpose Aggregation Operations Map-reduce  어그리게이션 파이프라인(Aggregation Pipeline) Aggregation pipeline 은 파이프라인 이용해 데이터의 집계를 처리하는 프레임워크입니다. 여러 스테이지에 걸쳐 도큐먼트들을 집계된 결과로 변경합니다.
아래 예를 살펴봅시다:
db.orders.aggregate([{ $match: { status: &#34;A&#34; } },{ $group: { _id: &#34;$custmor_id&#34;, total: { $sum: &#34;$amount&#34; } } }]) $match 스테이지는 도큐먼트들을 status 필드가 &quot;A&quot; 인 데이터만 다음 스테이지로 보냅니다."/>

<meta itemprop="name" content="MongoDB 스터디 8주차(aggregation)">
<meta itemprop="description" content="어그리게이션(Aggregation) 어그리게이션 작업은 데이터를 처리하여 계산된 결과를 반환합니다. 어그리게이션은 여러 도큐먼트의 값을 그룹화하고, 데이터에 다양한 작업을 수행한 후 단일 결과를 반환할 수 있습니다. MongoDB는 세 가지 어그리게이션을 제공합니다.
 Aggregation Pipeline Single Purpose Aggregation Operations Map-reduce  어그리게이션 파이프라인(Aggregation Pipeline) Aggregation pipeline 은 파이프라인 이용해 데이터의 집계를 처리하는 프레임워크입니다. 여러 스테이지에 걸쳐 도큐먼트들을 집계된 결과로 변경합니다.
아래 예를 살펴봅시다:
db.orders.aggregate([{ $match: { status: &#34;A&#34; } },{ $group: { _id: &#34;$custmor_id&#34;, total: { $sum: &#34;$amount&#34; } } }]) $match 스테이지는 도큐먼트들을 status 필드가 &quot;A&quot; 인 데이터만 다음 스테이지로 보냅니다.">
<meta itemprop="datePublished" content="2021-03-07T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-11T07:45:48&#43;09:00" />
<meta itemprop="wordCount" content="1076">



<meta itemprop="keywords" content="MongoDB," />

<link rel="stylesheet" href="/css/layout.css" />


<link rel="stylesheet" href="/css/default-dark.css" />


<link href="/font/d2coding.css" rel="stylesheet" type="text/css">

<title>


     MongoDB 스터디 8주차(aggregation) 

</title>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9117575221392760"
     crossorigin="anonymous"></script>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://marsettler.com/">Marsettler</a>
    </div> 

    <a class="nav-item" href="/tags"><div class="nav-item-title">Tags</div></a>
    
    
    <a class="nav-item" href="/wiki/"><div class="nav-item-title">Wiki</div></a>
    
    <a class="nav-item" href="/about-me/"><div class="nav-item-title">About Me</div></a>
    

  </nav>

  
<div class="social-links-header">

  
  <a href="mailto:jaewan.huey.park@gmail.com"><div class="social-link">email</div></a>
  

  
  <a href="https://github.com/hueypark" target="_blank"><div class="social-link">gh</div></a>
  

  

  
  <a href="https://twitter.com/jaewanHueyPark" target="_blank"><div class="social-link">twtr</div></a>
  

  

</div>


</div>


</header>


<article class="post">
    <h1 class="title"> MongoDB 스터디 8주차(aggregation) </h1>
    <div class="content"> <h1 id="aggregation">어그리게이션(Aggregation)</h1>
<p>어그리게이션 작업은 데이터를 처리하여 계산된 결과를 반환합니다. 어그리게이션은 여러 도큐먼트의 값을 그룹화하고, 데이터에
다양한 작업을 수행한 후 단일 결과를 반환할 수 있습니다. MongoDB는 세 가지 어그리게이션을 제공합니다.</p>
<ul>
<li>Aggregation Pipeline</li>
<li>Single Purpose Aggregation Operations</li>
<li>Map-reduce</li>
</ul>
<h1 id="-aggregation-pipeline">어그리게이션 파이프라인(Aggregation Pipeline)</h1>
<p>Aggregation pipeline 은 파이프라인 이용해 데이터의 집계를 처리하는 프레임워크입니다. 여러 스테이지에 걸쳐 도큐먼트들을
집계된 결과로 변경합니다.</p>
<p>아래 예를 살펴봅시다:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">orders</span>.<span style="color:#a6e22e">aggregate</span>([
	{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A&#34;</span> } },
	{ <span style="color:#a6e22e">$group</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$custmor_id&#34;</span>, <span style="color:#a6e22e">total</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$sum</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$amount&#34;</span> } } }
])
</code></pre></div><p><img src="/mongodb/mongodb-study-week-8/aggregate.png" alt=""></p>
<ol>
<li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#pipe._S_match">$match</a> 스테이지는 도큐먼트들을
<code>status</code> 필드가 <code>&quot;A&quot;</code> 인 데이터만 다음 스테이지로 보냅니다.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/#pipe._S_group">$group</a> 스테이지는 <code>custmor_id</code> 로
도큐먼트를 그룹화 한 다음 <code>$amount</code> 의 합을 계산합니다.</li>
</ol>
<h2 id="heading">파이프라인</h2>
<p>파이프라인은 스테이지들로 구성됩니다. 각 스테이지는 도큐먼트들 처리해 변환합니다. 스테이지는 하나의 입력된 도큐먼트보다
많거나 적은 도큐먼트를 반환 할 수도 있습니다. 예를 들어 새 문서를 생성하거나 기존 문서를 필터링 할 수 있습니다.</p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/out/#pipe._S_out">$out</a>,
<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/merge/#pipe._S_merge">$merge</a>,
<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/geoNear/#pipe._S_geoNear">$geoNear</a>
를 제외한 스테이지는 파이프라인에 여러 번 사용될 수 있습니다.</p>
<h2 id="heading1">고려사항</h2>
<h3 id="--httpsdocsmongodbcommanualcoreaggregationpipelinelimits"><a href="https://docs.mongodb.com/manual/core/aggregation-pipeline-limits/">어그리게이션 파이프라인 제약사항</a></h3>
<ul>
<li>결과 크기 제한
<ul>
<li>반환되는 도큐먼트 크기는 16 메가바이트로 제한됩니다</li>
<li>이 제한은 마지막으로 반환되는 도큐먼트에만 적용되고, 파이프라인 안에서는 더 클 수 있습니다.</li>
</ul>
</li>
<li>메모리 제한
<ul>
<li>스테이지는 100 메가바이트 이상의 메모리를 쓸 수 없습니다.</li>
<li>그보다 큰 데이터를 처리하려면 <code>allowDiskUse</code> 옵션을 사용해 데이터를 임시 파일에 쓸 수 있습니다.</li>
</ul>
</li>
</ul>
<h3 id="--httpsdocsmongodbcommanualcoreaggregationpipelineoptimization"><a href="https://docs.mongodb.com/manual/core/aggregation-pipeline-optimization/">어그리게이션 파이프라인 최적화</a></h3>
<p>최적화 단계를 거쳐 성능이 향상됩니다. <code>explain</code> 최적화된 결과를 볼 수 있습니다.</p>
<h3 id="-">프로젝션 최적화:</h3>
<p>결과를 얻기 위해 도큐먼트의 일부 필드만 필요하다면, 나머지 필드를 제외하여 파이프라인을 통과하는 데이터 양을 줄입니다.</p>
<h3 id="--">파이프라인 시퀀스 최적화:</h3>
<h4 id="project-or-unset-or-addfields-or-set--match--">(<code>$project</code> or <code>$unset</code> or <code>$addFields</code> or <code>$set</code>) + <code>$match</code> 시퀀스 최적화</h4>
<p>전:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$addFields</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">maxTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$max</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$times&#34;</span> },
    <span style="color:#a6e22e">minTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$min</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$times&#34;</span> }
} },
{ <span style="color:#a6e22e">$project</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">times</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">maxTime</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">minTime</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
    <span style="color:#a6e22e">avgTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$avg</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;$maxTime&#34;</span>, <span style="color:#e6db74">&#34;$minTime&#34;</span>] }
} },
{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Joe Schmoe&#34;</span>,
    <span style="color:#a6e22e">maxTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$lt</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">20</span> },
    <span style="color:#a6e22e">minTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gt</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> },
    <span style="color:#a6e22e">avgTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gt</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">7</span> }
} }
</code></pre></div><p>후:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Joe Schmoe&#34;</span> } },
{ <span style="color:#a6e22e">$addFields</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">maxTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$max</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$times&#34;</span> },
    <span style="color:#a6e22e">minTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$min</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$times&#34;</span> }
} },
{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">maxTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$lt</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">20</span> }, <span style="color:#a6e22e">minTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gt</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> } } },
{ <span style="color:#a6e22e">$project</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">times</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">maxTime</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">minTime</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
    <span style="color:#a6e22e">avgTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$avg</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;$maxTime&#34;</span>, <span style="color:#e6db74">&#34;$minTime&#34;</span>] }
} },
{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">avgTime</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gt</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">7</span> } } }
</code></pre></div><h4 id="sort--match--"><code>$sort</code> + <code>$match</code> 시퀀스 최적화</h4>
<p>전:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$sort</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">age</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> } },
{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;A&#39;</span> } }
</code></pre></div><p>후:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;A&#39;</span> } },
{ <span style="color:#a6e22e">$sort</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">age</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> } }
</code></pre></div><h4 id="redact--match--"><code>$redact</code> + <code>$match</code> 시퀀스 최적화</h4>
<p>전:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$redact</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$cond</span><span style="color:#f92672">:</span> { <span style="color:#66d9ef">if</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$eq</span><span style="color:#f92672">:</span> [ <span style="color:#e6db74">&#34;$level&#34;</span>, <span style="color:#ae81ff">5</span> ] }, <span style="color:#a6e22e">then</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$$PRUNE&#34;</span>, <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$$DESCEND&#34;</span> } } },
{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">year</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2014</span>, <span style="color:#a6e22e">category</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$ne</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Z&#34;</span> } } }
</code></pre></div><p>후:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">year</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2014</span> } },
{ <span style="color:#a6e22e">$redact</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$cond</span><span style="color:#f92672">:</span> { <span style="color:#66d9ef">if</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$eq</span><span style="color:#f92672">:</span> [ <span style="color:#e6db74">&#34;$level&#34;</span>, <span style="color:#ae81ff">5</span> ] }, <span style="color:#a6e22e">then</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$$PRUNE&#34;</span>, <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$$DESCEND&#34;</span> } } },
{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">year</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2014</span>, <span style="color:#a6e22e">category</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$ne</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Z&#34;</span> } } }
</code></pre></div><h4 id="projectunset--skip--"><code>$project/$unset</code> + <code>$skip</code> 시퀀스 최적화</h4>
<p>전:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$sort</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">age</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> } },
{ <span style="color:#a6e22e">$project</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> } },
{ <span style="color:#a6e22e">$skip</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> }
</code></pre></div><p>후:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$sort</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">age</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> } },
{ <span style="color:#a6e22e">$skip</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> },
{ <span style="color:#a6e22e">$project</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> } }
</code></pre></div><h3 id="-coalescence-">파이프라인 병합(Coalescence) 최적화</h3>
<h4 id="sort--limit-"><code>$sort</code> + <code>$limit</code> 병합</h4>
<p>전:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$sort</span> <span style="color:#f92672">:</span> { <span style="color:#a6e22e">age</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> } },
{ <span style="color:#a6e22e">$project</span> <span style="color:#f92672">:</span> { <span style="color:#a6e22e">age</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">status</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">name</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> } },
{ <span style="color:#a6e22e">$limit</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> }
</code></pre></div><p>후:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#e6db74">&#34;$sort&#34;</span> <span style="color:#f92672">:</span> {
       <span style="color:#e6db74">&#34;sortKey&#34;</span> <span style="color:#f92672">:</span> {
          <span style="color:#e6db74">&#34;age&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
       },
       <span style="color:#e6db74">&#34;limit&#34;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">5</span>)
    }
},
{ <span style="color:#e6db74">&#34;$project&#34;</span> <span style="color:#f92672">:</span> {
         <span style="color:#e6db74">&#34;age&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
         <span style="color:#e6db74">&#34;status&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
         <span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
  }
}
</code></pre></div><h4 id="limit--limit-"><code>$limit</code> + <code>$limit</code> 병합</h4>
<p>전:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$limit</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span> },
{ <span style="color:#a6e22e">$limit</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> }
</code></pre></div><p>후:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$limit</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> }
</code></pre></div><h4 id="skip--skip-"><code>$skip</code> + <code>$skip</code> 병합</h4>
<p>전:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$skip</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> },
{ <span style="color:#a6e22e">$skip</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span> }
</code></pre></div><p>후:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$skip</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">7</span> }
</code></pre></div><h4 id="match--match-"><code>$match</code> + <code>$match</code> 병합</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">year</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2014</span> } },
{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A&#34;</span> } }
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$and</span><span style="color:#f92672">:</span> [ { <span style="color:#e6db74">&#34;year&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2014</span> }, { <span style="color:#e6db74">&#34;status&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A&#34;</span> } ] } }
</code></pre></div><h4 id="lookup--unwind-"><code>$lookup</code> + <code>$unwind</code> 병합</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#a6e22e">$lookup</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">from</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;otherCollection&#34;</span>,
    <span style="color:#a6e22e">as</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;resultingArray&#34;</span>,
    <span style="color:#a6e22e">localField</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;x&#34;</span>,
    <span style="color:#a6e22e">foreignField</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;y&#34;</span>
  }
},
{ <span style="color:#a6e22e">$unwind</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$resultingArray&#34;</span>}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#a6e22e">$lookup</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">from</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;otherCollection&#34;</span>,
    <span style="color:#a6e22e">as</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;resultingArray&#34;</span>,
    <span style="color:#a6e22e">localField</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;x&#34;</span>,
    <span style="color:#a6e22e">foreignField</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;y&#34;</span>,
    <span style="color:#a6e22e">unwinding</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">preserveNullAndEmptyArrays</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span> }
  }
}
</code></pre></div><h4 id="sort--skip--limit-"><code>$sort</code> + <code>$skip</code> + <code>$limit</code> 시퀀스</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">$sort</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">age</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> } },
{ <span style="color:#a6e22e">$skip</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> },
{ <span style="color:#a6e22e">$limit</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> }
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
   <span style="color:#e6db74">&#34;$sort&#34;</span> <span style="color:#f92672">:</span> {
      <span style="color:#e6db74">&#34;sortKey&#34;</span> <span style="color:#f92672">:</span> {
         <span style="color:#e6db74">&#34;age&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
      },
      <span style="color:#e6db74">&#34;limit&#34;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">15</span>)
   }
},
{
   <span style="color:#e6db74">&#34;$skip&#34;</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">10</span>)
}
</code></pre></div><h3 id="---httpsdocsmongodbcommanualcoreaggregationpipelineshardedcollections"><a href="https://docs.mongodb.com/manual/core/aggregation-pipeline-sharded-collections/">샤딩된 컬렉션에 대한 어그리게이션</a></h3>
<h4 id="heading2">동작방식</h4>
<p>만약 파이프라인이 샤드 키로 구분 가능한 <code>$match</code> 로 시작하면 해당 샤드에서만 파이프라인이 실행됩니다.</p>
<p>작업이 여러 샤드에서 실행되면 결과는 <code>mongos</code> 로 라우팅 되어 합쳐집니다.(아래 경우를 제외하고)</p>
<ul>
<li>파이프라인이 <code>$out</code> 또는 <code>$lookup</code> 스테이지를 가지고 있으면 프라이머리 샤드에서 머지됩니다.</li>
<li>파이프라인이 sort 또는 grouping 스테이지를 가지고 있고, <a href="allowDiskUse">allowDiskUse</a> 설정이 켜저 있으면 머지는 임의로
선택된 샤드에서 실행됩니다.</li>
</ul>
<h4 id="heading3">최적화</h4>
<p>파이프라인을 두 파트로 나눌 수 있다면, 가능한 한 많은 단계로 나누어 실행되게 최적화합니다.</p>
<h1 id="---httpsdocsmongodbcommanualtutorialaggregationzipcodedataset"><a href="https://docs.mongodb.com/manual/tutorial/aggregation-zip-code-data-set/">예: 우편번호 데이터 어그리게이션</a></h1>
<h2 id="-1">데이터 모델</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;10280&#34;</span>,     <span style="color:#75715e">// 우편번호
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;city&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;NEW YORK&#34;</span>, <span style="color:#75715e">// 도시
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;state&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;NY&#34;</span>,      <span style="color:#75715e">// 주(약자)
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;pop&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5574</span>,        <span style="color:#75715e">// 인구
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#34;loc&#34;</span><span style="color:#f92672">:</span> [            <span style="color:#75715e">// 위치(위경도 좌표)
</span><span style="color:#75715e"></span>    <span style="color:#f92672">-</span><span style="color:#ae81ff">74.016323</span>,
    <span style="color:#ae81ff">40.710537</span>
  ]
}
</code></pre></div><h2 id="------">천만 명 이상의 인구가 있는 주 반환</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">zipcodes</span>.<span style="color:#a6e22e">aggregate</span>( [
   { <span style="color:#a6e22e">$group</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$state&#34;</span>, <span style="color:#a6e22e">totalPop</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$sum</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$pop&#34;</span> } } },
   { <span style="color:#a6e22e">$match</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">totalPop</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gte</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span> } } }
] )
</code></pre></div><p>결과</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#e6db74">&#34;_id&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;AK&#34;</span>,
  <span style="color:#e6db74">&#34;totalPop&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">550043</span>
}
</code></pre></div><h2 id="-----">주 내 도시의 평균 인구 반환</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">zipcodes</span>.<span style="color:#a6e22e">aggregate</span>( [
   { <span style="color:#a6e22e">$group</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">state</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$state&#34;</span>, <span style="color:#a6e22e">city</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$city&#34;</span> }, <span style="color:#a6e22e">pop</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$sum</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$pop&#34;</span> } } },
   { <span style="color:#a6e22e">$group</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$_id.state&#34;</span>, <span style="color:#a6e22e">avgCityPop</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$avg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$pop&#34;</span> } } }
] )
</code></pre></div><p>결과</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#e6db74">&#34;_id&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;MN&#34;</span>,
  <span style="color:#e6db74">&#34;avgCityPop&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">5335</span>
}
</code></pre></div><h2 id="--------">주 내 가장 큰 도시와 가장 작은 도시 반환</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">zipcodes</span>.<span style="color:#a6e22e">aggregate</span>( [
   { <span style="color:#a6e22e">$group</span><span style="color:#f92672">:</span>
      {
        <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">state</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$state&#34;</span>, <span style="color:#a6e22e">city</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$city&#34;</span> },
        <span style="color:#a6e22e">pop</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$sum</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$pop&#34;</span> }
      }
   },
   { <span style="color:#a6e22e">$sort</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">pop</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> } },
   { <span style="color:#a6e22e">$group</span><span style="color:#f92672">:</span>
      {
        <span style="color:#a6e22e">_id</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$_id.state&#34;</span>,
        <span style="color:#a6e22e">biggestCity</span><span style="color:#f92672">:</span>  { <span style="color:#a6e22e">$last</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$_id.city&#34;</span> },
        <span style="color:#a6e22e">biggestPop</span><span style="color:#f92672">:</span>   { <span style="color:#a6e22e">$last</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$pop&#34;</span> },
        <span style="color:#a6e22e">smallestCity</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$first</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$_id.city&#34;</span> },
        <span style="color:#a6e22e">smallestPop</span><span style="color:#f92672">:</span>  { <span style="color:#a6e22e">$first</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$pop&#34;</span> }
      }
   },

  <span style="color:#75715e">// the following $project is optional, and
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// modifies the output format.
</span><span style="color:#75715e"></span>
  { <span style="color:#a6e22e">$project</span><span style="color:#f92672">:</span>
    { <span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
      <span style="color:#a6e22e">state</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$_id&#34;</span>,
      <span style="color:#a6e22e">biggestCity</span><span style="color:#f92672">:</span>  { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$biggestCity&#34;</span>,  <span style="color:#a6e22e">pop</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$biggestPop&#34;</span> },
      <span style="color:#a6e22e">smallestCity</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$smallestCity&#34;</span>, <span style="color:#a6e22e">pop</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;$smallestPop&#34;</span> }
    }
  }
] )
</code></pre></div><p>결과</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#e6db74">&#34;state&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;RI&#34;</span>,
  <span style="color:#e6db74">&#34;biggestCity&#34;</span> <span style="color:#f92672">:</span> {
    <span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;CRANSTON&#34;</span>,
    <span style="color:#e6db74">&#34;pop&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">176404</span>
  },
  <span style="color:#e6db74">&#34;smallestCity&#34;</span> <span style="color:#f92672">:</span> {
    <span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;CLAYVILLE&#34;</span>,
    <span style="color:#e6db74">&#34;pop&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">45</span>
  }
}
</code></pre></div><h1 id="heading4">참고자료</h1>
<ul>
<li><a href="https://docs.mongodb.com/manual/aggregation/">MongoDB 문서 중 Aggregation</a></li>
</ul>
 </div>
    <footer class="post-footer">
  <div class="post-footer-data">
    
<div class="tags">
  
    
      <div class="tag">
        <a href="/tags/mongodb">#MongoDB</a>
      </div>
    
  
</div>

    <div class="date">created: 2021-03-07 | updated: 2021-03-11</div>
    
  </div>
</footer>

<script src="https://utteranc.es/client.js"
        repo="hueypark/wiki"
        issue-term="pathname"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script>


</article>

  <footer>

  <div class="social-links-footer">

  
  <a href="mailto:jaewan.huey.park@gmail.com"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/hueypark" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  
  <a href="https://twitter.com/jaewanHueyPark" target="_blank"><div class="social-link">Twitter</div></a>
  

  

  

</div>

  <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
  TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>


  <div class="copyright">  </div>

  <div class="poweredby">
    Powered by <a href="https://gohugo.io/">Hugo</a>.
  </div>

  </footer>

</div> 

<script async src="/js/mermaid/mermaid.min.js"></script>

</body>
</html>

